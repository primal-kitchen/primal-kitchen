name: 'create-env-file-on-server'
on: workflow_dispatch
jobs:
  do-it:
    runs-on: ubuntu-20.04
    steps:
      - name: 'create-env-file'
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.APP_DOMAIN }}
          username: ${{ secrets.SERVER_USERNAME }}
          key: ${{ secrets.CD_SSH_PRIVATE_KEY }}
          passphrase: ${{ secrets.CD_SSH_PRIVATE_KEY_PASSPHRASE }} # added security
          # TODO: fingerprint validation
          script_stop: true # stop after first failure in script
          script: |
            cd ${{ secrets.SERVER_APP_DIRECTORY }}
            rm --force .env # force is needed to prevent error if not exists
            echo " \
              # generated by github action [2] \
              APP_DOMAIN=${{ secrets.APP_DOMAIN }} \
              APP_CONTAINER_REGISTRY=${{ secrets.APP_CONTAINER_REGISTRY }} \
              APP_DEVELOPER_EMAIL=${{ secrets.APP_DEVELOPER_EMAIL }} \
              SERVER_USERNAME=${{ secrets.SERVER_USERNAME }} \
              SERVER_APP_DIRECTORY=${{ secrets.SERVER_APP_DIRECTORY }} \
              SSL_CERTIFICATE_FILE=${{ secrets.SSL_CERTIFICATE_FILE }} \
              SSL_CERTIFICATE_PRIVATE_KEY_FILE=${{ secrets.SSL_CERTIFICATE_PRIVATE_KEY_FILE }} \
              # github actions CI/CD stuff \
              CD_SSH_PRIVATE_KEY=${{ secrets.CD_SSH_PRIVATE_KEY }} \
              CD_SSH_PRIVATE_KEY_PASSPHRASE=${{ secrets.CD_SSH_PRIVATE_KEY_PASSPHRASE }} \
              CD_DIGITALOCEAN_ACCESS_KEY=${{ secrets.CD_DIGITALOCEAN_ACCESS_KEY }} \
              # postgres \
              POSTGRES_USERNAME=${{ secrets.POSTGRES_USERNAME }} \
              POSTGRES_PASSWORD=${{ secrets.POSTGRES_PASSWORD }} \
              POSTGRES_DATABASE=${{ secrets.POSTGRES_DATABASE }} \
              POSTGRES_PORT=${{ secrets.POSTGRES_PORT }} \
              POSTGRES_VOLUME=${{ secrets.POSTGRES_VOLUME }} \
              POSTGRES_USING_SSL=${{ secrets.POSTGRES_USING_SSL }} \
              POSTGRES_HOST=${{ secrets.POSTGRES_HOST }} \
              # strapi \
              STRAPI_USERNAME=${{ secrets.STRAPI_USERNAME }} \
              STRAPI_PASSWORD=${{ secrets.STRAPI_PASSWORD }} \
              STRAPI_HOST_URL=${{ secrets.STRAPI_HOST_URL }} \
              STRAPI_PORT=${{ secrets.STRAPI_PORT }} \
              STRAPI_ADMIN_JWT_SECRET=${{ secrets.STRAPI_ADMIN_JWT_SECRET }} \
              STRAPI_CONTAINER_NAME=${{ secrets.STRAPI_CONTAINER_NAME }} \
              STRAPI_SUBDOMAIN=${{ secrets.STRAPI_SUBDOMAIN }} \
              # redis \
              REDIS_PORT=${{ secrets.REDIS_PORT }} \
              # minio \
              MINIO_ROOT_USER=${{ secrets.MINIO_ROOT_USER }} \
              MINIO_ROOT_PASSWORD=${{ secrets.MINIO_ROOT_PASSWORD }} \
              MINIO_ACCESS_KEY=${{ secrets.MINIO_ACCESS_KEY }} \
              MINIO_SECRET_KEY=${{ secrets.MINIO_SECRET_KEY }} \
              MINIO_HOSTNAME=${{ secrets.MINIO_HOSTNAME }} \
              MINIO_PORT=${{ secrets.MINIO_PORT }} \
              MINIO_CONSOLE_PORT=${{ secrets.MINIO_CONSOLE_PORT }} \
              MINIO_BUCKET=${{ secrets.MINIO_BUCKET }} \
              MINIO_SUBDOMAIN=${{ secrets.MINIO_SUBDOMAIN }} \
              MINIO_CONTAINER_NAME=${{ secrets.MINIO_CONTAINER_NAME }} \
              # medusa \
              MEDUSA_STOREFRONT_API_PORT=${{ secrets.MEDUSA_STOREFRONT_API_PORT }} \
              MEDUSA_STOREFRONT_SUBDOMAIN=${{ secrets.MEDUSA_STOREFRONT_SUBDOMAIN }} \
              MEDUSA_STOREFRONT_CONTAINER_NAME=${{ secrets.MEDUSA_STOREFRONT_CONTAINER_NAME }} \
              MEDUSA_STOREFRONT_COOKIE_SECRET=${{ secrets.MEDUSA_STOREFRONT_COOKIE_SECRET }} \
              MEDUSA_STOREFRONT_JWT_SECRET=${{ secrets.MEDUSA_STOREFRONT_JWT_SECRET }} \
              # medusa admin \
              MEDUSA_ADMIN_PANEL_PORT=${{ secrets.MEDUSA_ADMIN_PANEL_PORT }} \
              MEDUSA_ADMIN_PANEL_CONTAINER_NAME=${{ secrets.MEDUSA_ADMIN_PANEL_CONTAINER_NAME }} \
              MEDUSA_ADMIN_PANEL_SUBDOMAIN=${{ secrets.MEDUSA_ADMIN_PANEL_SUBDOMAIN }} \
              MEDUSA_ADMIN_EMAIL=${{ secrets.MEDUSA_ADMIN_EMAIL }} \
              MEDUSA_ADMIN_PASSWORD=${{ secrets.MEDUSA_ADMIN_PASSWORD }} \
              # frontend \
              FRONTEND_PORT=${{ secrets.FRONTEND_PORT }} \
              FRONTEND_CONTAINER_NAME=${{ secrets.FRONTEND_CONTAINER_NAME }} \
              # nginx \
              NGINX_WEBROOT=${{ secrets.NGINX_WEBROOT }} \
            " > .env
